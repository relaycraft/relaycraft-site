---
import Layout from '../../../layouts/Layout.astro';
import { Header } from '../../../components/Header';
import { Footer } from '../../../components/Footer';
import { getCollection, type CollectionEntry } from 'astro:content';
import { ui } from '../../../i18n/ui';

export async function getStaticPaths() {
  const blogs = await getCollection('blog');
  return blogs.map((entry) => ({
    params: { lang: entry.data.lang || 'en', slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { data } = entry;

const { lang } = Astro.params;
const currentLang = (lang as 'en' | 'zh') || 'en';
const content = ui[currentLang];

function formatDate(date: Date) {
  return new Date(date).toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function calculateReadingTime(content: string) {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

// Find the alternate language version of this post
const allPosts = await getCollection('blog');
const alternatePost = allPosts.find(p => 
  p.slug !== entry.slug && 
  p.data.lang !== currentLang &&
  (p.slug.includes('why-i-built') && entry.slug.includes('why-i-built')) // Simple matching logic for now
);
---

<Layout title={`${data.title} - RelayCraft Blog`} description={data.description} lang={currentLang}>
  <Header client:load lang={currentLang} content={content} />
  
  <main class="pt-24 pb-20">
    <article class="container px-4 md:px-6 mx-auto max-w-3xl">
      {/* Breadcrumb */}
      <nav class="mb-8 flex items-center justify-between">
        <a href={`/${currentLang}/blog`} class="inline-flex items-center gap-2 text-sm text-muted-foreground font-medium hover:text-primary transition-colors group">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform group-hover:-translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          {content['blog.back']}
        </a>
      </nav>

      {/* Header */}
      <header class="mb-12 relative">
        {/* Decorative gradient */}
        <div class="absolute -top-8 left-0 right-0 h-32 bg-gradient-to-b from-primary/5 to-transparent rounded-3xl -z-10"></div>
        
        {data.featured && (
          <span class="inline-flex items-center rounded-full bg-primary/10 border border-primary/20 px-4 py-1.5 text-sm font-semibold text-primary mb-6">
            {content['blog.featured_article']}
          </span>
        )}
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 leading-tight text-foreground">
          {data.title}
        </h1>
        <p class="text-xl text-muted-foreground mb-8 leading-relaxed font-medium">
          {data.description}
        </p>
        
        {/* Author & Meta */}
        <div class="flex flex-wrap items-center gap-6 py-6 border-y border-border/50">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-primary-foreground font-bold text-lg shadow-lg shadow-primary/20">
              {data.author.split(' ').map(n => n[0]).join('')}
            </div>
            <div>
              <div class="font-bold text-foreground">{data.author}</div>
              <div class="text-sm font-medium text-muted-foreground">{content['blog.author']}</div>
            </div>
          </div>
          <div class="h-8 w-px bg-border/50 hidden sm:block"></div>
          <div class="flex items-center gap-2 text-muted-foreground font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
            <time datetime={data.pubDate.toISOString()}>
              {formatDate(data.pubDate)}
            </time>
          </div>
          <div class="h-8 w-px bg-border/50 hidden sm:block"></div>
          <div class="flex items-center gap-2 text-muted-foreground font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span>{calculateReadingTime(entry.body || '')} {content['blog.min_read']}</span>
          </div>
        </div>
        
        {/* Tags */}
        {data.tags && data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-6">
            {data.tags.map((tag: string) => (
              <span class="inline-flex items-center rounded-lg bg-muted px-3 py-1.5 text-sm font-semibold text-muted-foreground">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      {/* Content */}
      <div class="prose prose-lg dark:prose-invert max-w-none">
        <Content />
      </div>

      {/* Article Footer */}
      <footer class="mt-16 pt-8 border-t border-border/50">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
          <a 
            href={`/${currentLang}/blog`} 
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-muted text-foreground font-semibold hover:bg-accent hover:text-primary transition-all group"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform group-hover:-translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {content['blog.back']}
          </a>
          <div class="flex items-center gap-3">
            <span class="text-sm font-semibold text-muted-foreground">{content['blog.share']}</span>
            <a 
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(data.title)}&url=https://relaycraft.dev/${currentLang}/blog/${entry.slug}`}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2 rounded-lg bg-muted text-muted-foreground hover:bg-[#1DA1F2] hover:text-white transition-all shadow-sm"
              title="Share on X"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
            <a 
              href={`https://service.weibo.com/share/share.php?url=https://relaycraft.dev/${currentLang}/blog/${entry.slug}&title=${encodeURIComponent(data.title)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2 rounded-lg bg-muted text-muted-foreground hover:bg-[#E6162D] hover:text-white transition-all shadow-sm"
              title="分享到微博"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M10.098 20.323c-3.977.391-7.414-1.406-7.672-4.02-.259-2.609 2.759-5.047 6.74-5.441 3.979-.394 7.413 1.404 7.671 4.018.259 2.6-2.759 5.049-6.739 5.443zM9.05 17.219c-.384.616-1.208.884-1.829.602-.612-.279-.793-.991-.406-1.593.379-.595 1.176-.861 1.793-.601.622.263.82.972.442 1.592zm1.27-1.627c-.141.237-.449.353-.689.253-.236-.09-.313-.361-.177-.586.138-.227.436-.346.672-.24.239.09.315.36.194.573zm.176-2.719c-1.893-.493-4.033.45-4.857 2.118-.836 1.704-.026 3.591 1.886 4.21 1.983.64 4.318-.341 5.132-2.179.8-1.793-.201-3.642-2.161-4.149zm7.563-1.224c-.346-.105-.578-.18-.405-.649.388-1.032.428-1.923.009-2.558-.786-1.193-2.936-1.129-5.411-.032 0 0-.774.34-.577-.275.383-1.217.324-2.236-.27-2.82-1.35-1.327-4.941-.046-8.024 2.867C1.336 10.706 0 13.127 0 15.213c0 3.987 5.121 6.415 10.131 6.415 6.571 0 10.946-3.82 10.946-6.854 0-1.835-1.55-2.876-2.988-3.125zm2.009-5.662c-.819-.894-2.027-1.294-3.139-1.159l.024-.002c-.399.049-.674.409-.615.803.059.394.418.67.812.619.632-.078 1.319.149 1.769.641.449.492.591 1.148.428 1.732-.088.378.144.761.516.864.373.103.76-.127.869-.501.267-1.001.025-2.103-.764-2.997zm2.632-2.871c-1.474-1.609-3.648-2.329-5.651-2.086-.426.052-.721.437-.66.86.062.424.438.724.856.672 1.496-.182 3.119.354 4.218 1.554 1.1 1.2 1.45 2.761 1.091 4.171-.099.377.121.768.49.874.37.106.76-.116.867-.486.476-1.868.01-3.931-1.211-5.559z"/></svg>
            </a>
          </div>
        </div>
      </footer>
    </article>
  </main>
  
  <Footer content={content} />
</Layout>
